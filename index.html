<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£åœ°åå°‹æ ¹ (åŠ å¼·ç‰ˆ)</title>
    <script src="places_db.js"></script>
    <style>
        :root { --primary: #37474f; --secondary: #c62828; --bg: #eceff1; --card-bg: #fff; --accent: #ff9800; }
        body { font-family: "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding-bottom: 60px; color: #333; user-select: none; }
        
        header { background: #263238; color: #fff; padding: 30px 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: relative; }
        h1 { margin: 0; font-size: 1.8rem; }
        p { color: #b0bec5; font-size: 0.9rem; margin-top: 5px; }

        /* éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ• */
        .audio-ctrl { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: #fff; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: 0.3s; display: flex; align-items: center; gap: 5px; }
        .audio-ctrl:hover { background: rgba(255,255,255,0.4); }
        .audio-ctrl.muted { opacity: 0.6; text-decoration: line-through; }

        .nav { display: flex; justify-content: center; gap: 10px; padding: 15px; background: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-btn { padding: 8px 20px; border: 1px solid var(--primary); border-radius: 20px; background: transparent; color: var(--primary); font-weight: bold; cursor: pointer; transition: 0.3s; }
        .nav-btn.active { background: var(--primary); color: #fff; }

        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* æ¯æ—¥ä¸€æŠ½ */
        .daily-card-container { perspective: 1000px; max-width: 400px; height: 520px; margin: 20px auto; cursor: pointer; }
        .daily-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; }
        .daily-card-container.flipped .daily-card-inner { transform: rotateY(180deg); }
        .daily-card-front, .daily-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); overflow: hidden; }
        .daily-card-front { background: linear-gradient(135deg, #37474f, #546e7a); color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .front-icon { font-size: 5rem; margin-bottom: 20px; }
        .daily-card-back { background: #fff; transform: rotateY(180deg); display: flex; flex-direction: column; }
        .daily-img-box { width: 100%; height: 50%; background: #ddd; position: relative; }
        .daily-img { width: 100%; height: 100%; object-fit: cover; }
        .daily-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }

        /* åˆ—è¡¨ */
        .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; justify-content: center; }
        select, input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .grid-item { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; border-left: 5px solid transparent; }
        .grid-item:hover { transform: translateY(-3px); border-left-color: var(--secondary); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .grid-item h3 { margin: 5px 0; color: var(--primary); font-size: 1.1rem; }
        .grid-item .old { color: var(--secondary); font-weight: bold; font-size: 0.9rem; }

        /* æ¸¬é©— */
        .quiz-box { max-width: 600px; margin: auto; background: #fff; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .quiz-img-box { width: 100%; height: 250px; margin-bottom: 20px; border-radius: 12px; overflow: hidden; background: #eee; }
        .quiz-img { width: 100%; height: 100%; object-fit: cover; }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .q-btn { padding: 15px; border: 1px solid #ddd; background: #fff; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.2s; }
        .q-btn:hover:not(:disabled) { background: #f5f5f5; }
        .q-btn.correct { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; animation: pop 0.3s; }
        .q-btn.wrong { background: #ffebee; border-color: #ef5350; color: #c62828; animation: shake 0.4s; }

        @keyframes pop { 0%{transform:scale(1);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-5px);} 75%{transform:translateX(5px);} }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 15px; }
        .modal-content { background: #fff; width: 100%; max-width: 500px; border-radius: 15px; overflow: hidden; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s; }
        .modal-body { padding: 25px; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<header>
    <h1>ğŸ—ºï¸ å°ç£åœ°åå°‹æ ¹ (åŠ å¼·ç‰ˆ)</h1>
    <p>å®Œæ•´æ”¶éŒ„å…¨å°è¡Œæ”¿å€èˆ‡å¤åœ°åç”±ä¾†</p>
    <button class="audio-ctrl" onclick="SoundMgr.toggle()">ğŸ”Š éŸ³æ¨‚: é–‹</button>
</header>

<div class="nav">
    <button class="nav-btn active" onclick="setTab('daily', this)">ğŸ“… æ¯æ—¥ä¸€åœ°</button>
    <button class="nav-btn" onclick="setTab('quiz', this)">âœï¸ åœ°åæ¸¬é©—</button>
    <button class="nav-btn" onclick="setTab('list', this)">ğŸ“– å®Œæ•´åˆ—è¡¨</button>
</div>

<div class="container">
    <div id="tab-daily" class="section active">
        <div class="daily-card-container" onclick="flipCard()">
            <div class="daily-card-inner">
                <div class="daily-card-front">
                    <div class="front-icon">ğŸ´</div>
                    <h2>ä»Šæ—¥é‹å‹¢åœ°å</h2>
                    <p>é»æ“Šç¿»é–‹ï¼Œæ¢ç´¢ä»Šæ—¥çš„ç·£åˆ†ä¹‹åœ°</p>
                    <small style="margin-top:20px; opacity:0.7;">(æ¯æ—¥ 00:00 æ›´æ–°)</small>
                </div>
                <div class="daily-card-back">
                    <div class="daily-img-box"><img id="d-img" class="daily-img" src=""></div>
                    <div class="daily-content" onclick="openModal(dailyItem); event.stopPropagation();">
                        <h2 id="d-fullname" style="margin:0 0 10px 0; font-size:1.5rem; color:var(--primary);"></h2>
                        <div style="color:var(--secondary); font-weight:bold; margin-bottom:10px;" id="d-old"></div>
                        <p style="font-size:0.9rem; color:#666;">(é»æ“ŠæŸ¥çœ‹è©³ç´°æ•…äº‹)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-quiz" class="section">
        <div class="quiz-box">
            <div class="quiz-img-box"><img id="q-img" class="quiz-img" src=""></div>
            <h3 style="color:#666; margin:0 0 10px 0;">è«‹å•é€™å€‹åœ°æ–¹çš„å¤åœ°åæ˜¯ï¼Ÿ</h3>
            <h1 id="q-question" style="font-size:2rem; margin:10px 0; color:var(--primary);"></h1>
            <div id="q-options" class="quiz-options"></div>
            <div id="q-feedback" style="margin-top:15px; text-align:left; display:none; background:#f9f9f9; padding:15px; border-radius:8px;"></div>
            <button onclick="SoundMgr.play('click'); initQuiz()" style="margin-top:20px; padding:10px 30px; background:var(--primary); color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:1rem;">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="tab-list" class="section">
        <div class="filter-bar">
            <select id="county-filter" onchange="renderList()">
                <option value="">å…¨å°ç¸£å¸‚</option>
            </select>
            <input type="text" id="keyword" placeholder="æœå°‹åœ°å..." onkeyup="renderList()">
        </div>
        <div id="list-grid" class="grid"></div>
        <div style="text-align:center; margin-top:20px; color:#888; font-size:0.8rem;">å…±æ”¶éŒ„ <span id="total-count">0</span> ç­†è³‡æ–™</div>
    </div>
</div>

<div id="modal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <img id="m-img" style="width:100%; height:250px; object-fit:cover;">
        <div class="modal-body">
            <h2 id="m-name" style="margin:5px 0; color:var(--primary);"></h2>
            <div id="m-old" style="background:#eee; display:inline-block; padding:5px 10px; border-radius:5px; font-weight:bold; margin-bottom:15px;"></div>
            <p id="m-desc" style="line-height:1.6; text-align:justify;"></p>
            <button onclick="closeModal()" style="width:100%; padding:12px; background:var(--primary); color:#fff; border:none; border-radius:8px; cursor:pointer;">é—œé–‰</button>
        </div>
    </div>
</div>

<script>
// --- éŸ³æ•ˆç®¡ç†å“¡ (SoundManager) ---
const SoundMgr = {
    enabled: true,
    bgm: new Audio('https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112778.mp3'), // è¼•éŸ³æ¨‚é€£çµ
    ctx: null, // AudioContext for SFX

    init: function() {
        this.bgm.loop = true;
        this.bgm.volume = 0.3;
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
    },

    toggle: function() {
        this.enabled = !this.enabled;
        const btn = document.querySelector('.audio-ctrl');
        if(this.enabled) {
            btn.innerHTML = 'ğŸ”Š éŸ³æ¨‚: é–‹';
            btn.classList.remove('muted');
            this.bgm.play().catch(e => console.log("éœ€ä½¿ç”¨è€…äº’å‹•æ‰èƒ½æ’­æ”¾"));
        } else {
            btn.innerHTML = 'ğŸ”‡ éŸ³æ¨‚: é—œ';
            btn.classList.add('muted');
            this.bgm.pause();
        }
    },

    // æ’­æ”¾éŸ³æ•ˆ (ä½¿ç”¨ Oscillator ç”¢ç”Ÿï¼Œä¸éœ€å¤–éƒ¨æª”æ¡ˆ)
    play: function(type) {
        if(!this.enabled || !this.ctx) return;
        if(this.ctx.state === 'suspended') this.ctx.resume();

        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);

        const now = this.ctx.currentTime;
        
        if (type === 'correct') {
            // å®å’š (é«˜éŸ³é›™éŸ¿)
            osc.type = 'sine';
            osc.frequency.setValueAtTime(660, now);
            osc.frequency.setValueAtTime(880, now + 0.1);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc.start(now);
            osc.stop(now + 0.5);
        } else if (type === 'wrong') {
            // å­ (ä½éŸ³)
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(100, now + 0.3);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        } else if (type === 'flip') {
            // å’» (ç™½å™ªéŸ³æˆ–æ»‘éŸ³)
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.exponentialRampToValueAtTime(800, now + 0.2);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start(now);
            osc.stop(now + 0.2);
        } else if (type === 'click') {
            // è¼•é»
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, now);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        }
    }
};

// --- é‚è¼¯åˆå§‹åŒ– ---
// æ³¨æ„ï¼šè³‡æ–™åº« placesData ä¾†è‡ª places_db.js
let dailyItem;

async function init() {
    SoundMgr.init(); // åˆå§‹åŒ–éŸ³æ•ˆå¼•æ“
    
    // æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦è®€å–æˆåŠŸ
    if(typeof placesData === 'undefined') {
        alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° places_db.js è³‡æ–™åº«æª”æ¡ˆï¼");
        return;
    }

    document.getElementById('total-count').innerText = placesData.length;

    // æ¯æ—¥ä¸€æŠ½
    const date = new Date();
    const seed = date.getFullYear()*10000 + (date.getMonth()+1)*100 + date.getDate();
    dailyItem = placesData[seed % placesData.length];
    
    document.getElementById('d-fullname').innerText = dailyItem.c + " " + dailyItem.n;
    document.getElementById('d-old').innerText = "å¤ç¨±ï¼š" + dailyItem.o;
    document.getElementById('d-img').src = await getImg(dailyItem.n, dailyItem.c);

    // åˆ—è¡¨ç¯©é¸åˆå§‹åŒ–
    const select = document.getElementById('county-filter');
    [...new Set(placesData.map(x=>x.c))].forEach(c => {
        select.innerHTML += `<option value="${c}">${c}</option>`;
    });
    renderList();

    // å˜—è©¦è‡ªå‹•æ’­æ”¾éŸ³æ¨‚ (ç€è¦½å™¨å¯èƒ½æœƒæ“‹ï¼Œé€šå¸¸éœ€è¦ç¬¬ä¸€æ¬¡é»æ“Š)
    document.body.addEventListener('click', () => {
        if(SoundMgr.enabled && SoundMgr.bgm.paused) SoundMgr.bgm.play().catch(()=>{});
    }, {once:true});
}

// å–å¾—åœ–ç‰‡ (Wikipedia API)
async function getImg(n, c) {
    const kws = [`${c}${n}`, n, c]; // æœå°‹å„ªå…ˆé †åº
    for(let k of kws) {
        try {
            const url = `https://zh.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(k)}&prop=pageimages&format=json&pithumbsize=500&origin=*`;
            const res = await fetch(url);
            const data = await res.json();
            const pages = data.query.pages;
            const pageId = Object.keys(pages)[0];
            if(pageId !== "-1" && pages[pageId].thumbnail) return pages[pageId].thumbnail.source;
        } catch(e){}
    }
    // é è¨­åœ–åº«
    return "https://images.unsplash.com/photo-1541336032412-2048a678540d?w=600&q=80";
}

// ç¿»ç‰Œ
function flipCard() {
    const container = document.querySelector('.daily-card-container');
    const isFlipped = container.classList.contains('flipped');
    if(!isFlipped) SoundMgr.play('flip'); // æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ
    container.classList.toggle('flipped');
}

// æ¸¬é©—é‚è¼¯
let qItem;
async function initQuiz() {
    document.getElementById('q-feedback').style.display = 'none';
    qItem = placesData[Math.floor(Math.random()*placesData.length)];
    
    document.getElementById('q-question').innerText = qItem.c + " " + qItem.n;
    // æ›å€‹é è¨­åœ–ç‰‡è®“è¼‰å…¥æ„Ÿæ›´å¥½
    document.getElementById('q-img').src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="; 
    document.getElementById('q-img').src = await getImg(qItem.n, qItem.c);

    let opts = [qItem];
    while(opts.length < 4) {
        let r = placesData[Math.floor(Math.random()*placesData.length)];
        // ç¢ºä¿ä¸é‡è¤‡ä¸”ç­”æ¡ˆä¸ç›¸åŒ
        if(!opts.includes(r) && r.o !== qItem.o) opts.push(r);
    }
    opts.sort(()=>Math.random()-0.5);

    document.getElementById('q-options').innerHTML = opts.map(o => 
        `<button class="q-btn" onclick="checkQuiz(this, '${o.o}')">${o.o}</button>`
    ).join('');
}

function checkQuiz(btn, ans) {
    const btns = document.querySelectorAll('.q-btn');
    if(btn.disabled) return; // é˜²æ­¢é‡è¤‡é»æ“Š

    btns.forEach(b => b.disabled = true);
    const fb = document.getElementById('q-feedback');
    fb.style.display = 'block';

    if(ans === qItem.o) {
        SoundMgr.play('correct'); // æ’­æ”¾æ­£ç¢ºéŸ³æ•ˆ
        btn.classList.add('correct');
        fb.innerHTML = `<b style="color:green">âœ… ç­”å°äº†ï¼</b><br>${qItem.d}`;
    } else {
        SoundMgr.play('wrong'); // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
        btn.classList.add('wrong');
        btns.forEach(b => { if(b.innerText === qItem.o) b.classList.add('correct'); });
        fb.innerHTML = `<b style="color:red">âŒ ç­”éŒ¯äº†ï¼Œæ­£ç¢ºæ˜¯ ${qItem.o}</b><br>${qItem.d}`;
    }
}

// åˆ—è¡¨æ¸²æŸ“
function renderList() {
    const grid = document.getElementById('list-grid');
    const cf = document.getElementById('county-filter').value;
    const kw = document.getElementById('keyword').value.toLowerCase();
    const list = placesData.filter(x => (cf==="" || x.c===cf) && (x.n.includes(kw) || x.o.includes(kw)));
    
    // æ•ˆèƒ½å„ªåŒ–ï¼šå¦‚æœæ•¸é‡å¤ªå¤šåªé¡¯ç¤ºå‰ 50 ç­†ï¼Œé¿å…å¡é “ï¼Œæˆ–ç›´æ¥æ¸²æŸ“
    grid.innerHTML = list.slice(0, 100).map(item => `
        <div class="grid-item" onclick='SoundMgr.play("click"); openModal(${JSON.stringify(item)})'>
            <h3>${item.c} ${item.n}</h3>
            <div class="old">å¤ï¼š${item.o}</div>
        </div>
    `).join('');
    
    if(list.length > 100) {
        grid.innerHTML += `<div style="grid-column:1/-1; text-align:center; padding:10px; color:#888;">(åƒ…é¡¯ç¤ºå‰ 100 ç­†çµæœï¼Œè«‹ä½¿ç”¨æœå°‹ç¸®å°ç¯„åœ)</div>`;
    }
}

async function openModal(item) {
    if(typeof item === 'string') item = JSON.parse(item);
    SoundMgr.play('click');
    document.getElementById('m-name').innerText = item.c + " " + item.n;
    document.getElementById('m-old').innerText = "å¤ç¨±ï¼š" + item.o;
    document.getElementById('m-desc').innerText = item.d;
    document.getElementById('m-img').src = await getImg(item.n, item.c);
    document.getElementById('modal').style.display = 'flex';
}

function closeModal() { 
    SoundMgr.play('click');
    document.getElementById('modal').style.display = 'none'; 
}

function setTab(id, btn) {
    SoundMgr.play('click');
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    btn.classList.add('active');
    if(id==='quiz') initQuiz();
}

window.onload = init;
</script>

</body>
</html>
